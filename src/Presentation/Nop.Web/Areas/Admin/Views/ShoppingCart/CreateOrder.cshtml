@model OrderCreateOrUpdateModel
@inject IEventPublisher eventPublisher

@{
    //page title
    ViewBag.Title = T("Admin.Orders.CreateOrderDetails").Text;
    //active menu item (system name)
    Html.SetActiveMenuItemSystemName("Create Order");
}

<form asp-controller="ShoppingCart" asp-action="CreateOrder" asp-route-customerId="@Model.CustomerId" method="post" id="order-form">
    <div class="content-header clearfix">
        <h1 class="pull-left">
            @T("Admin.Orders.CreateOrderDetails")
        </h1>
        <div class="pull-right">
            <button type="submit" name="save" class="btn bg-blue">
                <i class="fa fa-floppy-o"></i>
                @T("Admin.Common.Save")
            </button>
            <input type="submit" id="btnRefreshPage" style="display: none" />
            <script type="text/javascript">
                $(document).ready(function () {
                    $('#btnRefreshPage').click(function () {
                        //refresh pageed
                        location.reload();
                    });
                });
            </script>

        </div>
    </div>

    <div asp-validation-summary="All"></div>

    <div class="content">
        <div class="form-horizontal">
            <div class="panel-group">
                <div class="panel panel-default panel-search">
                    <div class="panel-body">
                        <div class="form-group">
                            <div class="col-md-4">
                                <nop-label asp-for="CustomerId" />
                            </div>
                            <div class="col-md-8">

                                <input type="hidden" name="CustomerId" id="CustomerId" class="form-control" value="@(Model.CustomerId > 0 ? Model.CustomerId.ToString() : string.Empty)" />
                                <input type="text" name="CustomerName" id="CustomerName" class="form-control" placeholder="@(T("Admin.Common.PleaseInputDataSearch"))" value="@Model.CustomerFullName" />
                            </div>
                            <script>

                                $(document).ready(function() {
                                    $("#CustomerName").autocomplete({
                                        delay: 1000,
                                        source: function(request, response) {

                                            var postData = {
                                                searchTerm: request.term
                                            };
                                            addAntiForgeryToken(postData);

                                            $.ajax({
                                                cache: false,
                                                type: "POST",
                                                url: "@(Url.Action("CustomersSearch", "Customer"))",
                                                data: postData,
                                                complete: function(result) {
                                                    response($.map(result.responseJSON.Data,
                                                        function(item) {
                                                            return {
                                                                label: item.FullName,
                                                                value: item.Id
                                                            }
                                                        }));
                                                },
                                                error: function(xhr, ajaxOptions, thrownError) {
                                                    alert(thrownError);
                                                },
                                                traditional: true
                                            });
                                        },
                                        minLength: 2,
                                        select: function(event, ui) {
                                            $('#CustomerId').val(ui.item.value);
                                            this.value = ui.item.label;
                                            return false;
                                        },
                                        focus: function(event, ui) {
                                            event.preventDefault();
                                            this.value = ui.item.label;
                                        },search: function (e, u) {
                                            $(this).addClass('ajaxprocessing');
                                        },
                                        response: function( event, ui ) {
                                            $(this).removeClass('ajaxprocessing');
                                        }
                                    });
                                })

                            </script>
                        </div>
                    </div>
                </div>
            </div>
            <nop-tabs id="order-edit">
                <nop-tab asp-name="tab-info" asp-title="@T("Admin.Orders.ListProductInfo")" asp-default="true">@await Html.PartialAsync("_ListProductInfo", Model.ProductListModel)</nop-tab>
                @if (Model.ShoppingCartModel != null)
                    {
                            <nop-tab asp-name="tab-cart-info" asp-title="@T("Admin.Orders.AdminCart")">@await Html.PartialAsync("_AdminCustomerCart", Model.ShoppingCartModel)</nop-tab>
                }
            @*<nop-tab asp-name="tab-shipping-info" asp-title="@T("Admin.Orders.ShippingInfo")">@await Html.PartialAsync("_OrderDetails.Shipping", Model)</nop-tab>*@
            </nop-tabs>
        </div>
    </div>
    <input type="submit" id="btnRefresh" style="display: none"/>
    <input type="text" id="setActiveTab" style="display: none" value=""/>
    <script type="text/javascript">
        $(document).ready(function() {
            $('#btnRefresh').click(function() {
                var customerId = $('#CustomerId').val();
                var activeTab = $('#setActiveTab').val();
                window.location.href = "@Url.Action("CreateOrder","ShoppingCart")?customerId=" + customerId+"&activetab="+activeTab;
            });
        });
    </script>
    @{
        //custom tabs
        var eventMessage = new AdminTabStripCreated(this.Html, "order-edit");
        eventPublisher.Publish(eventMessage);
        foreach (var eventBlock in eventMessage.BlocksToRender)
        {
            @eventBlock
        }
    }
</form>
